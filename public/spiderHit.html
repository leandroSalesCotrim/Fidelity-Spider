<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spider-Hit</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="img/icones/aranha-vermelha.ico" type="image/x-icon">

</head>
<body>

    <!-- MENU -->
    <header>
        <div class="container">
            <div class="div_logo_sony">
                <img id="logo_sony" src="img/sony-logo-branca.png" draggable="false" alt="Logo Sony">
            </div>
        </div>
    </header>

    <!-- CONTEUDO -->
    <div class="div_spider_Hit">
        <div class="container">
            
            <div class="div_img_voltar">
                <a href="dashboard.html">
                    <img src="img/icones/voltar.png" alt="">
                </a>
            </div>
            
            <div class="SpiderPoints">
                <h5><b><span>SpiderPoints:</span><span id="span_sp"></span></b></h5>
            </div>

            <div class="btn_dark_mode" >
                <img id="src_icon" onclick="dark_mode()" draggable="false" src="img/icones/dark-mode-dark.png" alt="Modo escuro">
            </div>
        
        </div>

        <div id="iniciar_card" class="iniciar_card">
            <button onclick="iniciar_jogo()">Iniciar</button>
        </div>

        <div class="containerA">
            
            <div class="desc_minigame">
                <div class="titulo">
                    <h1>Spider Hit</h1>
                    <hr>
                </div>
                <h4>
                    Jogue agora Spider hit e acumule pontos para resgatar recompensas. <br>
                    Convide um amigo para disputar com você e descubra quem é o melhor lutador em Spider hit.
                </h4>

                <h5>
                    <span>Curiosidade</span>: a cada rodado jogada você ganha 300 pontos
                </h5>
            </div>
            
            <div class="card_minigame">
                <div class="card_minigame_tela">
                    <div id="j1">
                        <img id="img_j1" src="img/spiderhit/aranha_pose.png" alt="">
                    </div>

                    <div id="j2">
                        <img id="img_j2" src="img/spiderhit/venom_pose.png" alt="">
                    </div>
                    
                </div>

                <div class="card_minigame_menu">
                    <div class="card_minigame_statusJ1">
                        
                        <div class="icon_j1">
                            <img src="img/aranha-branca.png" alt="">
                        </div>

                        <div class="info_j1">
                            <h1>Homem-aranha</h1>
                            <div class="barra_vida_j1">
                                <div id="vida_j1" class="vida_j1">
                                </div>
                            </div>
                            <h5 id="hp_j1_atual">100</h5><h5>HP</h5>
                        </div>

                        <div class="tecla_j1">
                            <div class="img_tecla1_j1"> <img id="teclaA" src="img/spiderhit/tecladoA.png" alt=""></div>
                            <div class="img_tecla2_j1"> <img id="teclaD"src="img/spiderhit/tecladoD.png" alt=""></div>
                        </div>

                    </div>

                    <div class="card_minigame_statusJ2">
                        
                        <div class="tecla_j2">
                            <div class="img_tecla1_j2"> <img id="teclaJ" src="img/spiderhit/tecladoJ.png" alt=""></div>
                            <div class="img_tecla2_j2"> <img id="teclaK" src="img/spiderhit/tecladoK.png" alt=""></div>
                        </div>

                        <div class="info_j2">
                            <h1>Venom</h1>
                            <div class="barra_vida_j2">
                                <div id="vida_j2"class="vida_j2">
                                </div>
                            </div>
                            <h5 id="hp_j2_atual">100</h5><h5>HP</h5>
                        </div>

                        <div class="icon_j2">
                            <img src="img/venom.png" alt="">
                        </div>
                        

                    </div>
                </div>

            </div>

        </div>
        <div class="div_img_fundo">
            <div class="img_venom" id="img_venom">
                <img src="img/venom_2.png" alt="">
            </div>

            <div class="img_superiorsm" >
                <img src="img/superiorsm.png" alt="">
            </div>

        </div>
    </div>
</body>
</html>

<script>
    sp = Number(sessionStorage.SPIDERPOINTS_USUARIO);
    id_usuario = sessionStorage.ID_USUARIO;
    span_sp.innerHTML=sp;

    var hp_j1 = 100;
    var hp_j2 = 100;
    var anim_soco_j1 = 0;
    var anim_soco_j2 = 0;
    var anim_desvio_j1 = 0;
    var anim_desvio_j2 = 0;
    var partida = 0;

    function atualizar_sp() {
       
        sp = sp+300;

        var corpo = {
            id_usuario: id_usuario,
            spider_points: sp
        }


        fetch(`/usuarios/acumular`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(corpo)
            
        }).then(function (resposta) {
        
            console.log("resposta: ", resposta);
        
            if (resposta.ok) {
                window.alert("O usuario ganhou 300 SpiderPoints");
                sessionStorage.SPIDERPOINTS_USUARIO = sp;
                location.reload();
            } else {
                throw ("Houve um erro ao tentar adicionar os pontos!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        return false;
    }

    function iniciar_jogo(){
        iniciar_card.style.display = "none";
        partida = 1; //inicia partida
        img_j2.style.transform = 'scaleX(-1)';
        img_venom.style.transform = 'scaleX(-1)';
        
        //se a partida for iniciada, o jogo funciona
        if(partida == 1){

            //Função que reconhece as teclas pressionadas na pagina e faz a lógica do jogo e animações
            function gameplay (event) {
                    
                //Se o evento do key code == 65 (letra A) retornar true,então faça a animação 
                if (event.keyCode == 65) { 
                    img_j1.src = "img/spiderhit/aranha_soco.png";//troca para imagem de soco
                    teclaA.src = "img/spiderhit/tecladoA-vermelho.png"
                    
                    anim_soco_j1 = 1;
                        
                    //Após 200ms de entrar no if, retorna a imagem a forma original 
                    setTimeout(function(){
                        img_j1.src = "img/spiderhit/aranha_pose.png";//volta para imagem original
                        teclaA.src = "img/spiderhit/tecladoA.png"

                        anim_soco_j1 = 0;
                    }, 200);
                    
                    
                }else if (event.keyCode == 68){
                    img_j1.src = "img/spiderhit/aranha_desvio.png";//troca para imagem de desvio
                    teclaD.src = "img/spiderhit/tecladoD-vermelho.png"
                    img_j1.style.height = "70%";//troca a altura
                    img_j1.style.marginTop = "60%";//troca a posição
                    
                    anim_desvio_j1 = 1;

                    //Após 200ms de entrar no if, retorna a imagem a forma original
                    setTimeout(function(){
                        img_j1.src = "img/spiderhit/aranha_pose.png";//volta para imagem original
                        teclaD.src = "img/spiderhit/tecladoD.png"
                        img_j1.style.height = "100%";//volta para altura original
                        img_j1.style.marginTop = "0%";//volta para posição original
                        
                        anim_desvio_j1 = 0;
                    }, 200);

                }else if (event.keyCode == 74){
                    img_j2.src = "img/spiderhit/venom_soco.png";//troca para imagem de soco
                    teclaJ.src = "img/spiderhit/tecladoJ-vermelho.png"
                    
                    anim_soco_j2 = 1;
                    
                    //Após 200ms de entrar no if, retorna a imagem a forma original
                    setTimeout(function(){
                        img_j2.src = "img/spiderhit/venom_pose.png";//volta para imagem original
                        teclaJ.src = "img/spiderhit/tecladoJ.png"
                        
                        anim_soco_j2 = 0;
                    }, 200);

                }else if (event.keyCode == 75){
                    img_j2.src = "img/spiderhit/venom_desvio.png";//troca para imagem de desvio
                    teclaK.src = "img/spiderhit/tecladoK-vermelho.png"

                    img_j2.style.height = "70%";//troca a altura
                    img_j2.style.marginTop = "25%";//troca a posição

                    anim_desvio_j2 = 1;
                
                    //Após 200ms de entrar no if, retorna a imagem a forma original
                    setTimeout(function(){
                        img_j2.src = "img/spiderhit/venom_pose.png";//volta para imagem original
                        teclaK.src = "img/spiderhit/tecladoK.png"
                        img_j2.style.height = "100%";//volta para altura original
                        img_j2.style.marginTop = "0%";//volta para posição original
                        
                        anim_desvio_j2 = 0;
                        
                    }, 200);
                }

                //se o J1 dar um soco e o J2 não desviar, o J2 recebe dano
                if(anim_soco_j1 == 1 && anim_desvio_j2 == 0){

                    vida_j2.style.width = Number(hp_j2_atual.innerHTML)+"%";  
                    hp_j2_atual.innerHTML = Number(hp_j2_atual.innerHTML) - 3;

                }else 
                //Se a animação de desvio do J2 e a animação de ataque do j1 forem ativadas ao mesmo tempo
                //Não faça nada
                if(anim_desvio_j2 == 1 && anim_soco_j1 == 1){
                }
                
                //se o J2 dar um soco e o J1 não desviar, o J1 recebe dano
                if(anim_soco_j2 == 1 && anim_desvio_j1 == 0){

                    vida_j1.style.width = Number(hp_j1_atual.innerHTML)+"%";
                    hp_j1_atual.innerHTML = Number(hp_j1_atual.innerHTML) - 3;

                }else 
                //Se a animação de desvio do J2 e a animação de ataque do j1 forem ativadas ao mesmo tempo
                //Não faça nada
                if(anim_desvio_j1 == 1 && anim_soco_j2 == 1){
                }

                //Se um dos jogadores tiver a vida menor ou igual a 0, a partida se
                //encerra e o eventListener para reconhecer as teclas é removido
                if(Number(hp_j2_atual.innerHTML) <= 0 || Number(hp_j1_atual.innerHTML) <= 0 ){
                    document.removeEventListener('keydown', gameplay);
                    partida = 0;

                    if(Number(hp_j2_atual.innerHTML) <= 0){
                        alert("Fim de jogo \nHomem-aranha venceu");
                        var vencedor = "Homem-aranha";
                    }else if(Number(hp_j1_atual.innerHTML) <= 0){
                        alert("Fim de jogo \nVenom venceu");
                        var vencedor = "Venom";
                    }

                    atualizar_sp();
                    vitoriaSh();
                }

                function vitoriaSh() {
                    var corpo = {
                        id_usuario: id_usuario,
                        vencedor: vencedor
                    }
                    fetch(`/usuarios/vitoriaSh`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(corpo)
                    }).then(function (resposta) {
                        console.log("resposta: ", resposta);
                        if (resposta.ok) {
                            throw ("Tudo certo!");
                        } else {
                            throw ("Houve um erro ao tentar adicionar os pontos!");
                        }
                    }).catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                    });
                    return false;
                }
            }
            //adicionando evento que chama função ao pressionar a tecla especificada em "keycode"
            document.addEventListener('keydown', gameplay );
        }else{
        }
    }
</script>
